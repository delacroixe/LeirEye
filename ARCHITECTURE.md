#!/usr/bin/env bash

# Script de demostración de la arquitectura
# Muestra los flujos de datos del proyecto

echo ""
echo "╔════════════════════════════════════════════════════════════════════════════════╗"
echo "║          NETWORK TRAFFIC ANALYZER - DIAGRAMA DE ARQUITECTURA                  ║"
echo "╚════════════════════════════════════════════════════════════════════════════════╝"
echo ""

echo "┌─ CAPAS DE LA APLICACIÓN ──────────────────────────────────────────────────────┐"
echo "│                                                                               │"
echo "│  ┌─────────────────────────────────────────────────────────────────────────┐  │"
echo "│  │                         NAVEGADOR WEB                                   │  │"
echo "│  │                      (React Dashboard)                                  │  │"
echo "│  │                   http://localhost:3000                                 │  │"
echo "│  └─────────────────────────────────────────────────────────────────────────┘  │"
echo "│                                   │                                            │"
echo "│                    ┌──────────────┼──────────────┐                             │"
echo "│                    │              │              │                             │"
echo "│                 HTTP/REST      WebSocket      HTTP/REST                       │"
echo "│                    │              │              │                             │"
echo "│  ┌─────────────────────────────────────────────────────────────────────────┐  │"
echo "│  │                    FASTAPI SERVER                                       │  │"
echo "│  │                  http://localhost:8000                                  │  │"
echo "│  │                                                                         │  │"
echo "│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────┐  │  │"
echo "│  │  │  API Routes      │  │  WebSocket       │  │  Services            │  │  │"
echo "│  │  │  /api/capture/*  │  │  /api/capture/ws │  │  PacketCapture       │  │  │"
echo "│  │  │  /api/stats/*    │  │                  │  │  Service             │  │  │"
echo "│  │  └──────────────────┘  └──────────────────┘  └──────────────────────┘  │  │"
echo "│  └─────────────────────────────────────────────────────────────────────────┘  │"
echo "│                                   │                                            │"
echo "│                          ┌────────┴────────┐                                  │"
echo "│                          │                 │                                  │"
echo "│                       Scapy            Eventos                                 │"
echo "│                          │                 │                                  │"
echo "│  ┌─────────────────────────────────────────────────────────────────────────┐  │"
echo "│  │                   SISTEMA OPERATIVO                                     │  │"
echo "│  │                                                                         │  │"
echo "│  │  ┌──────────────────────────────────────────────────────────────────┐   │  │"
echo "│  │  │             Captura de Paquetes de Red                           │   │  │"
echo "│  │  │                  (sniff - Scapy)                                 │   │  │"
echo "│  │  │                                                                  │   │  │"
echo "│  │  │  eth0 / en0 / wlan0 ────→ Parser ────→ Estadísticas ────→ WS  │   │  │"
echo "│  │  └──────────────────────────────────────────────────────────────────┘   │  │"
echo "│  └─────────────────────────────────────────────────────────────────────────┘  │"
echo "│                                                                               │"
echo "└───────────────────────────────────────────────────────────────────────────────┘"
echo ""

echo "┌─ FLUJO DE CAPTURA DE PAQUETES ────────────────────────────────────────────────┐"
echo "│                                                                               │"
echo "│  Usuario hace clic en \"Iniciar Captura\"                                       │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  Frontend envía POST /api/capture/start                                       │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  Backend inicia PacketCaptureService.start_capture()                          │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  Scapy comienza sniff() en interfaz de red                                    │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  Por cada paquete:                                                            │"
echo "│    1. Parse paquete (IP, TCP/UDP/ICMP, puertos, flags)                       │"
echo "│    2. Actualizar estadísticas (conteos, IPs, puertos)                        │"
echo "│    3. Enviar vía WebSocket al frontend                                       │"
echo "│    4. Guardar en buffer (máx 200 en memoria)                                 │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  Frontend recibe evento WebSocket                                             │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  React actualiza estado (setPackets)                                          │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  Componentes se re-renderizan:                                                │"
echo "│    - PacketTable añade nueva fila                                             │"
echo "│    - Statistics actualiza gráficos                                            │"
echo "│           │                                                                   │"
echo "│           ▼                                                                   │"
echo "│  Usuario ve paquetes en tiempo real                                           │"
echo "│                                                                               │"
echo "└───────────────────────────────────────────────────────────────────────────────┘"
echo ""

echo "┌─ ENDPOINTS DISPONIBLES ───────────────────────────────────────────────────────┐"
echo "│                                                                               │"
echo "│  CAPTURA:                                                                    │"
echo "│    POST   /api/capture/start       ← Inicia captura                          │"
echo "│    POST   /api/capture/stop        ← Detiene captura                         │"
echo "│    GET    /api/capture/status      ← Status actual                           │"
echo "│    GET    /api/capture/packets     ← Últimos paquetes                        │"
echo "│    POST   /api/capture/clear       ← Limpia buffer                           │"
echo "│    WS     /api/capture/ws          ← WebSocket streaming                     │"
echo "│                                                                               │"
echo "│  ESTADÍSTICAS:                                                               │"
echo "│    GET    /api/stats/summary       ← Resumen completo                        │"
echo "│    GET    /api/stats/protocols     ← Dist. protocolos                        │"
echo "│    GET    /api/stats/top-ips       ← Top IPs origen/destino                  │"
echo "│    GET    /api/stats/top-ports     ← Top puertos                             │"
echo "│                                                                               │"
echo "└───────────────────────────────────────────────────────────────────────────────┘"
echo ""

echo "┌─ COMPONENTES REACT ───────────────────────────────────────────────────────────┐"
echo "│                                                                               │"
echo "│  App.tsx (Estado global)                                                     │"
echo "│    ├── packets: PacketData[]                                                 │"
echo "│    ├── isCapturing: boolean                                                  │"
echo "│    └── refreshStats: number                                                  │"
echo "│           │                                                                   │"
echo "│           ├─→ CaptureControls.tsx                                             │"
echo "│           │   └─ Controles de inicio/parada de captura                        │"
echo "│           │                                                                   │"
echo "│           ├─→ Statistics.tsx                                                  │"
echo "│           │   ├─ Tarjetas de resumen                                          │"
echo "│           │   ├─ Gráfico de protocolos (Pie)                                 │"
echo "│           │   ├─ Top IPs (Bar)                                               │"
echo "│           │   └─ Top puertos (Horizontal Bar)                                │"
echo "│           │                                                                   │"
echo "│           └─→ PacketTable.tsx                                                 │"
echo "│               ├─ Tabla de paquetes                                            │"
echo "│               └─ Expandible por fila con detalles                             │"
echo "│                                                                               │"
echo "└───────────────────────────────────────────────────────────────────────────────┘"
echo ""

echo "┌─ SERVICIOS TYPESCRIPT ────────────────────────────────────────────────────────┐"
echo "│                                                                               │"
echo "│  services/api.ts                                                             │"
echo "│    ├── startCapture()           ← POST /api/capture/start                    │"
echo "│    ├── stopCapture()            ← POST /api/capture/stop                     │"
echo "│    ├── getStatus()              ← GET /api/capture/status                    │"
echo "│    ├── getPackets()             ← GET /api/capture/packets                   │"
echo "│    ├── getStatsSummary()        ← GET /api/stats/summary                     │"
echo "│    ├── getProtocolDistribution()← GET /api/stats/protocols                   │"
echo "│    ├── getTopIps()              ← GET /api/stats/top-ips                     │"
echo "│    └── getTopPorts()            ← GET /api/stats/top-ports                   │"
echo "│                                                                               │"
echo "│  services/websocket.ts                                                       │"
echo "│    ├── connect()                ← Conecta a WS                               │"
echo "│    ├── disconnect()             ← Desconecta WS                              │"
echo "│    ├── send()                   ← Envía mensaje                              │"
echo "│    ├── on()                     ← Escucha eventos                            │"
echo "│    └── off()                    ← Deja de escuchar                           │"
echo "│                                                                               │"
echo "└───────────────────────────────────────────────────────────────────────────────┘"
echo ""

echo "┌─ MODELOS PYDANTIC (Backend) ──────────────────────────────────────────────────┐"
echo "│                                                                               │"
echo "│  PacketData                                                                  │"
echo "│    ├── timestamp: datetime                                                   │"
echo "│    ├── src_ip: str                                                           │"
echo "│    ├── dst_ip: str                                                           │"
echo "│    ├── src_port: Optional[int]                                               │"
echo "│    ├── dst_port: Optional[int]                                               │"
echo "│    ├── protocol: str (TCP/UDP/ICMP)                                          │"
echo "│    ├── length: int                                                           │"
echo "│    ├── payload_preview: Optional[str] (hex)                                  │"
echo "│    └── flags: Optional[str] (TCP flags)                                      │"
echo "│                                                                               │"
echo "│  CaptureRequest                                                              │"
echo "│    ├── interface: Optional[str]                                              │"
echo "│    ├── packet_filter: Optional[str] (BPF)                                    │"
echo "│    └── max_packets: int                                                      │"
echo "│                                                                               │"
echo "│  CaptureStatus                                                               │"
echo "│    ├── is_running: bool                                                      │"
echo "│    ├── packets_captured: int                                                 │"
echo "│    ├── interface: Optional[str]                                              │"
echo "│    └── filter: Optional[str]                                                 │"
echo "│                                                                               │"
echo "│  CaptureStats                                                                │"
echo "│    ├── total_packets: int                                                    │"
echo "│    ├── tcp_packets: int                                                      │"
echo "│    ├── udp_packets: int                                                      │"
echo "│    ├── icmp_packets: int                                                     │"
echo "│    ├── other_packets: int                                                    │"
echo "│    ├── top_src_ips: Dict[str, int]                                           │"
echo "│    ├── top_dst_ips: Dict[str, int]                                           │"
echo "│    ├── top_ports: Dict[int, int]                                             │"
echo "│    └── capture_duration: float                                               │"
echo "│                                                                               │"
echo "└───────────────────────────────────────────────────────────────────────────────┘"
echo ""

echo "┌─ EJEMPLO DE USO ──────────────────────────────────────────────────────────────┐"
echo "│                                                                               │"
echo "│  1. INICIAR DASHBOARD:                                                       │"
echo "│     $ sudo python3 run_dashboard.py                                           │"
echo "│                                                                               │"
echo "│  2. ABRIR NAVEGADOR:                                                         │"
echo "│     http://localhost:3000                                                    │"
echo "│                                                                               │"
echo "│  3. CONFIGURAR CAPTURA:                                                      │"
echo "│     Interfaz: en0 (o dejar vacío)                                            │"
echo "│     Filtro:   tcp port 80 (o dejar vacío)                                    │"
echo "│     Máximo:   1000 (por defecto)                                             │"
echo "│                                                                               │"
echo "│  4. HACER CLIC EN \"INICIAR CAPTURA\"                                          │"
echo "│                                                                               │"
echo "│  5. VER DATOS EN TIEMPO REAL:                                                │"
echo "│     - Paquetes en tabla                                                      │"
echo "│     - Gráficos actualizando                                                  │"
echo "│     - Estadísticas cambiando                                                 │"
echo "│                                                                               │"
echo "│  6. EXPANDIR FILAS PARA DETALLES:                                            │"
echo "│     Click en cualquier fila → Ver detalles completos                         │"
echo "│                                                                               │"
echo "│  7. DETENER CAPTURA:                                                         │"
echo "│     Click en \"Detener Captura\"                                              │"
echo "│                                                                               │"
echo "└───────────────────────────────────────────────────────────────────────────────┘"
echo ""

echo "╔════════════════════════════════════════════════════════════════════════════════╗"
echo "║                   ✅ ARQUITECTURA LISTA PARA USAR                              ║"
echo "╚════════════════════════════════════════════════════════════════════════════════╝"
echo ""
